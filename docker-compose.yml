version: '3.8'

services:
  # Broker MQTT
  mosquitto:
    image: eclipse-mosquitto:2.0
    ports:
      - "21662:1883"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - ai-network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure

  # Master Server (NodeJS)
  master:
    image: 10.1.2.166:5000/master:latest
    ports:
      - "31663:8888"    # Web App
      - "50051:50051"   # gRPC
    environment:
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
      - GRPC_PORT=50051
      - WEB_PORT=8888
      - MASTER_HOST=master
      # API Keys como variables de entorno (alternativa al archivo)
      # Descomenta y configura si prefieres usar env vars
      # - GEMINI_API_KEY_1=tu_key_1
      # - GEMINI_API_KEY_2=tu_key_2
      # - GEMINI_API_KEY_3=tu_key_3
      # - GEMINI_API_KEY_4=tu_key_4
    depends_on:
      - mosquitto
    networks:
      - ai-network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure

  # Worker Python
  worker-python:
    image: 10.1.2.166:5000/worker-python:latest
    environment:
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
    depends_on:
      - mosquitto
      - master
    networks:
      - ai-network
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure

  # Worker Go
  worker-go:
    image: 10.1.2.166:5000/worker-go:latest
    environment:
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
    depends_on:
      - mosquitto
      - master
    networks:
      - ai-network
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure

  # Worker Java
  worker-java:
    image: 10.1.2.166:5000/worker-java:latest
    environment:
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
    depends_on:
      - mosquitto
      - master
    networks:
      - ai-network
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure

networks:
  ai-network:
    driver: overlay
    attachable: true
